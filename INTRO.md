[TOC]

# 用QPython开发一个公交路线查询移动WebApp系统

搜索关键字：
-----

- QPython
- WebApp
- html5
- Web前端框架



概述
-----
在移动互联网应用开发的大潮中，有那么一种技术一直都在以主角的身份不断吸引诸多开发者的关注，它就是WebApp技术，和原生开发相比，WebApp能够快速兼容Web开发模式，快速上手，部署简单，因此得到了很多开发者的青睐。

QPython的WebApp方案就是众多WebApp方案中的极为优秀的一种，QPython 的 WEB APP 方案有以下优势：

- 它具有强大的本地逻辑处理解析器：Python 脚本解析器
QPython 有一个强大的本地逻辑处理解析器，能在你的手机端进行进（线）程运算、图形处理及渲染、进行多种协议的网络通讯等工作，这样不需要提交给云端就能充分地利用了手机处理能力。

- 海量的库支持，更快实现
Python 世界中积累了多年的大部分的类库都能够被快速引入到 QPython 体系中，因此您可以不必重复造轮子。

- 最小的开发环境要求
进行 QPython 开发，您只需要有一台安卓手机即可。当然您也可以在 PC 端完成开发，再将程序上传到 QPython 上；现在QPython已经推出了一个QWE(QPython Web Editor)工具，更能让你只需要通过一个浏览器就可以连接你的手机进行开发。


原理
--
通过 QPython，你可以在手机上启动自定义的的 Python 服务，包括 WEB 服务。这样你就可以用兼容Web开发的模式来快速开发WebApp了。


项目“公交线路查询”简介
---

我们将基于QPython的WebApp开发框架原理，我们主要使用html作为UI，使用Python来处理功能逻辑，来开发一个“公交线路查询应用”。


案例设计与实现
---------

### 需求分析

我们将要开发的公交线路查询应用将能帮助用户：

- 路线查询：查询指定城市的公交路线

- 换乘查询：能够查询指定城市起始站和目的站的换乘情况


#### 项目实现的功能:

经调研发现：爱帮公交提供给了开发者公交“线路查询”和“换乘查询”的API，开发者只需将用户输入的关键词作为参数去请求对应API，即可取得用户所期望的数据。

因此我们只需要调用爱帮对应的API，将其返回的结果良好地展示出来即可。


### 界面设计

有了 QPython 的支持，我们可以让QPython运行时加载对应的URL（包括本地我们自实现的WEB服务的网址），因此我们就可以用Web的方式来设计我们当前索要开发的WebApp界面。

这里使用了[Amaze UI前端框架](http://amazeui.org/)，并将核心文件（框架的js、css文件，html文件等）放置在项目的assets文件夹中，目录结构如图1-5所示。

WebApp的主界面如附件所示，顶部是常见的导航，下来是公交线路查询的项目名称，在下来是WebApp的主要功能模块，包括“线路查询”和“换乘查询”。


线路查询模块需要用户输入城市名和公交路线，查询按钮用于提交查询请求。


换乘查询需要用户输入城市名，起始地，目的地，查询按钮同样用语提交换乘查询请求。

在html中，可以使用<link>标签引用assets中的css，js等文件，href属性使用/assets 定位到assets目录下。

我们用QPython默认内置的bottle框架来来开发WebApp，它能很方便地支持逻辑和显示模版分层，因此我们首先要使用html语言来编写界面。已经知道了html、css、js等文件在工程目录assets中是如何放置后，就可以开始设计软件的主界面了。

#### 主界面index.html

设计要点：

1、引入了框架文件。使用link标签在head、body体中引入必要的css和js文件。

2、参照AmazeUI的官方文档，根据需求去引用框架已经定义好的美观的网页控件元素。

3、定义JavaScript函数供逻辑代码调用，比如处理提交查询操作。

主界面index.html的代码如下。

#### 查询结果展现页面detail.html

设计要点：

1、使用到AmazeUI的折叠菜单控件展现查询结果，具体代码请参照AmazeUI的官方文档和源码。

2、定义结果项插入相关JavaScript函数。定义appendDetail函数，用以将API返回的数据通过固定的格式添加到html节点中。定义resultCount函数，用以将返回结果条数显示到导航栏上。

查询路线结果展现页面detail.html代码如下：


#### 查询换乘结果的展示页面transfer.html，

设计要点：

1、同查询路线结果比较相似，transfer.html同样使用到AmazeUI的折叠菜单控件展现查询结果。

2、定义结果项插入相关JavaScript函数。定义appendTransfer函数，用以将API返回的数据通过固定的格式添加到html节点中。定义resultCount函数，用以将返回结果条数显示到导航栏上。



### 功能实现

接下来将介绍如何用 QPython 与爱帮API交互获得查询数据，同时将结果展示出来。

#### QPython的WebApp框架

QPython默认集成了[bottle Web开发框架](http://bottlepy.org/docs/dev/index.html) 在这个项目中，我们就是使用Bottle来进行开发。



#### 如何请求爱帮API进行查询

Python里的urllib2库支持对网络做请求，在项目中，我们也是直接使用该库请求爱帮的API来获得查询结果



#### 如何将结果展示出来

基于bottle框架，我们直接使用了bottle的模版引擎来将结果传递到模版中并返回给用户


#### 其他：如何自动获取地理位置

基于QPython的SL4A库，我们可以轻松地调用安卓的接口来获取地理位置坐标，再通过百度的查询接口，即可知道我们现在在哪个城市。




项目心得
-----
使用QPython之后，基本能用Web的开放模式来开发一个体验良好的WebApp。我们可以充分使用成熟的web前端框架来方便地构建风格友好的界面；基于Python的强大的库，我们能在手机上就轻松地处理网络请求等事务。由此可见，使用QPython开发能大大地加速WebApp的开发。除了网络、本地IO等处理能力外，QPython还具备SL4A库来操作安卓的摄像头、地理位置、蓝牙等特性。



参考资料
-----

项目源码：
https://github.com/qpython-apps/BusHelper/

QPython网站：
http://qpython.com/

爱帮公交线路查询API文档：
http://www.aibang.com/api/usage#bus_lines

AmazeUI前端框架官方网站：
http://amazeui.org/

常见问题
-------

### 使用QPython获取地理位置时为NULL

获取地理位置需要开启地理位置的权限，未打开该权限，获得的数据就会为NULL。有时及时打开该权限但如果还未获取到地理坐标时也会为NULL。

解决方法：
调用时如果为NULL则提示用户需要打开地理位置权限再返回。

